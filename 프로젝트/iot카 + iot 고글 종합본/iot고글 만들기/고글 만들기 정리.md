# iot 고글 만들기
> 목차

  1. 설정 목표 
  2. 사용 모듈 및 프로그램
  3. 환경 설정
  4. oled 사용


> 1. 목표

 - 라즈베리와 OLED 간 SPI 통신을 이용하여 정보를 주고 받는다.
 - OLED에 내가 원하는 창을 띄운다.
 - UHD의 원리를 이해한다.
 - 최종 적으로 iot RC 와 연동하여 음성인식을 통해 자동차를 움직인다.

>2. 사용 모듈 및 프로그램

  - raspberry zero
  - 0.9inch OLED 
  - i2s mic (마이크)
  - AR환경을 위한 반사판 및 Fresnel lens(볼록렌즈를 얇게 설계)를 사용하여 AR글래스의 크기와 무게를 잡았다.

>3. exaplme 출력하기
- 고양이 예제 출력
  - $ cd Adafruit_Python_SSD1306/examples
  - $ vi image.py (이건내가 만들었는지 이미 있었는지 기겅이 잘 안남)
  - <img src="~/../../img/고양이py.jpg"  width="300" height="400">
  - DC핀 연결 잘 환인하자
  - $ python3 image.py 
  - 고양이가 OLED에 출력
- 한글 폰트 설치:
  - $ wget -O malgun.ttf https://bit.ly/3BzjZfq
  - 나중에 화면에 한글 폰트를 출력할때 사용 
- 최종 날짜 표시(ssafy iot고글 폴더에 해달 파일 넣어둠)
  - $ python3 day1-arglass.py 
  - 버튼을 누르면서 작동이 되는 것을 확인하자.

>4. 마이크 사용 하기  (교안: 관통프로젝트-day2참고)
- 교안과 같이 마이크를 연결한다.
- $ sudo apt-get install raspberrypi-kernel-headers    //build파일을 생성해주는 역할
- $ sudo reboot
- $ mkdir ics43432
- $cd ics43432
- $ wget https://raw.githubusercontent.com/raspberrypi/linux/rpi-5.10.y/sound/soc/codecs/ics43432.c
  - rpi-5.10.y의 버전 확인은 uname -a 로 현재 버전을 확인. 현재는 5.10.17+
  - 아래 make에서 오류가 나는 것 같은데 아래와 같은 방법을 해도되고 아니면 아예 여기서 커널 버전을 변경해도 될듯?(예상)
- $ vi Makefile(띄어쓰기가 아니라 tap 사용) 
``` C
obj-m := ics43432.o
all:
  make -C /lib/modules/$(shell uname -r)/build M=$(PWD) modules
clean:
  make -C /lib/modules/$(shell uname -r)/build M=$(PWD) clean
install:
  sudo cp ics43432.ko /lib/modules/$(shell uname -r)
  # depmod : 모듈의 dependency 관계를 표로 작성함. modules.dep 파일
  sudo depmod -a
```
- $ make install all

- 만약 build 파일이 없다는 error가 발생한다면 아래 코드로 변경
  - 참고: build 파일 이 없어서 발생하는 오류 확인 방법 ->cd /lib/mobules/에 uname -a을 쳤을때 나오는 버전으로 cd해서 들어가보면 build 파일이 없을 것이다. 그럼 다른 버전중 build가 존재하는 커널 버전을 찾아 아래와 같이 하드코딩으로 경로를 설정해준다.
```C
obj-m := ics43432.o
all:
	make -C /lib/modules/5.10.103+/build M=$(PWD) modules
clean:
	make -C /lib/modules/lib/modules/5.10.103+/build M=$(PWD) clean
install:
	sudo cp ics43432.ko /lib/modules/5.10.103+/build
	sudo depmod -a
```

- $ wget https://raw.githubusercontent.com/lhdangerous/i2s-mems-mic/main/i2s-soundcard-overlay.dts 

- dtc 프로그램으로 dts를 컴파일하고 산출된 .dtbo 오버레이를 /boot/overlays 에 설치
  - $ dtc -@ -I dts -O dtb -o i2s-soundcard.dtbo i2s-soundcard-overlay.dts
  - sudo cp i2s-soundcard.dtbo /boot/overlays
  - warring은 일단 무시
- config.txt 부팅시 디바이스 사용함을 명시
  - $ sudo nano /boot/config.txt
  - 아래와 같이 설정

<img src="~/../../img/고글config캡쳐.jpg"  width="400" height="300">  

- $ sudo reboot 
- $ arecord -l 로 설치 확인

- 녹음 테스트
  - $ arecord -c1 -r48000 -fS16_LE -twav -d10 test.wav

- pyaudio는 오디오 I/O을 위한 closs-platform 라이브러리 PortAudio의 파이썬 구현이다. 오디오 데이터의 획득, 기록, 교
환등에 비교적 간편하게 사용할 수 있다. 참고: https://people.csail.mit.edu/hubert/pyaudio/docs/
  - $ sudo apt-get install portaudio19-dev
  - $ pip3 install pyaudio


> 5. 마이크를 이용하여 음성을 txt로 변환하기  google cloude 서비스 이용

1. 환경 설정<hr/>
<span style="color:orange">관통프로젝트 day3</sapn> 참고

- google Cloud platform 을 이용(계정 만드는 법을 교안을 참고)
- 키값 까지 다운로드 했다는 가정하에 밑에 과정 진행 (json파일로 다운로드)
- json 파일을 mobaxterm을 이용하여 home/pi 폴더(켜면 바로 있는 공간) 에 넣자
- 이름을 변경하자(굳이 안해도 되지만 편의를 위해): googleServiceKey
-  환경변수 설정
   - $ export GOOGLE_APPLICATION_CREDENTIALS="/home/pi/googleServiceKey.json"
   - 참고: 환경 변수 설정이후 자꾸 꺼지는 느낌이 있다. 그리고 좀 느려진 것 같기도 한데 이건 확인이 필요할 듯
- pyaudio 설치
  - sudo apt-get install portaudio19-dev
  - pip3 install pyaudio
- google cloud speech python 클라이언트 라이브러리 설치(pip최신버전 필요함)
  - $ pip3 install --upgrade pip   
  - $ pip3 install --use-deprecated=backtrack-on-build-failures google-cloud-speech  
  - 위코드는 만약에 문제가 생긴다면 이전버전으로 설치를 해라라는 뜻
2. 실제 test<hr/>
- <span style="color:orange">google 클라우드 서비스를 이용하려면 전원을 껐다켰을 경우 아래를 항상 입력</sapn>
```
 $ export GOOGLE_APPLICATION_CREDENTIALS="/home/pi/googleServiceKey.json"
```
- 실제 마이크 녹음후 testing 하기
  - 위의 $ arecord -c1 -r48000 -fS16_LE -twav -d10 test.wav 를 실행했다면 test.wave파일이 있을 것이다. 없으면 실행후 녹음
- (test 코드들은 ssafy iot 고글폴더안에 들어있다.)
- (1번 방법) 녹음된 파일을 분석하여 txt로 출력
```
$ python3 google_speech_from_file.py
```
- (2번 방법 )실시간으로 녹음 하면서 txt로 변환 , test.wav 파일 따로 필요x  
```
$ python3 transcribe_streaming_mic.py
```

> python에서 비동기처리를 해서 성능을 높여 보자

