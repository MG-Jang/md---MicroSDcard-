# 소켓

> 소켓이란
- 컴퓨터 네트워크를 경유하는 프로세스 간 통신의 종착점

> 서버 소켓 작성 순서 <span style="color:orange">(매우 중요)</spam>

- TCP 기반 서버에서 기본적인 함수 호출 순서는 다음과 같다
1. socket() 소켓 생성
   - sock = socket(PF_INET, SOCK_STREAM, 0);
   - PF_INET : IPv4  거의 이것만 사용할것이므로 변경할 필요x\
   - SOCK_STREAM: 연결지향형 통신
   - 0 : TCP/IP
   - <span style="color:orange">즉 TCP/IP 통신을 한다면 위와 동일하게 쓰면됨.</spam>
2. bind() 소켓에 주소 할당
    - 소켓 할당 (그냥 이거 가져다 쓰자)
    ```C
    // 소켓의 생성
    // 그러나, 아직 서버 소켓이라 부르긴 무리
    serv_sock = socket(PF_INET, SOCK_STREAM, 0);
    if (serv_sock == -1)
    error_handling("socket() error");

     // Time-wait 해제
     // SO_REUSEADDR 를 0에서 1 로 변경
     optlen = sizeof(option);
     option = 1;
    setsockopt(serv_sock, SOL_SOCKET, SO_REUSEADDR, (void *)&option, optlen);
        
    // 소켓의 주소 할당을 위해 구조체 변수 0으로 초기화
    memset(&serv_addr, 0, sizeof(serv_addr));
    // 주소체계 지정
    serv_addr.sin_family = AF_INET;
    // IP 주소 배정(네트워크 바이트 순서)
    // INNADDR_ANY 는 내 아이피 의미하는 상수
    serv_addr.sin_addr.s_addr = htonl(INADDR_ANY);
    // 문자열 기반 port 번호 초기화
    // 네트워크 바이트 순서
    serv_addr.sin_port = htons(atoi(argv[1]));
    // 소켓에 주소 정보 할당을 위해 bind 호출
    // 그러나, 아직 서버 소켓이라 부르긴 무리
    
    ```

    - 소켓 주소에 정상적으로 할당 되었는지 확인하는 구문
    ```C
         if (bind(serv_sock, (struct sockaddr *)&serv_addr, sizeof(serv_addr)) == -1){
         error_handling("bind() error");
    }
    ```
3. listen() 클라이언트 연결 요청 대기
```C
 // 연결요청 대기상태로 들어가기 위해 listen 호출
  // queue 의 크기는 5
  // 드디어, 서버 소켓(리스닝 소켓) 이라 부를 수 있게 됨
  if (listen(serv_sock, 5) == -1)
    error_handling("listen() error");

  clnt_addr_size = sizeof(clnt_addr);
```
4. accept() 클라이언트 연결 승인 
    - 예시 코드를 보면 무한 루프에 들어가있는데 그이유는<br>
    client가 들어오면 계속해서 받기위해
```C
    clnt_sock = accept(serv_sock, (struct sockaddr *)&clnt_addr, &clnt_addr_size);
    if (clnt_sock == -1)
      error_handling("accept() error");
```
5. read() / write() 통신
    - 
6. close() 소켓 닫기

> 예시 코드
- TCP를 사용하는 경우 아래와 같은 형태로 씀
```
sock = socket(PF_INET, SOCK_STREAM, 0);
```

- thread가 들어간 경우 ex)server 빌드할때 -plthread를 붙여야함
  - gcc ./chat_server.c -D_REENTRANT -o ./chat_server -lpthread